<form [formGroup]="form" (submit)="save()">
  <div class="type-head">{{ typeIdToString(type?.value) }}</div>
  <mat-tab-group (selectedIndexChange)="onTabIndexChanged($event)">
    <!-- GENERAL -->
    <mat-tab label="general">
      <!-- type (bound) -->
      <mat-form-field
        *ngIf="decElemTypeEntries?.length"
        style="width: 14em"
        appearance="fill"
      >
        <mat-select [formControl]="type" placeholder="type">
          <mat-option *ngFor="let e of decElemTypeEntries" [value]="e.id">{{
            e.value
          }}</mat-option>
        </mat-select>
        <mat-error
          *ngIf="$any(type).errors?.required && (type.dirty || type.touched)"
          >type required</mat-error
        >
      </mat-form-field>
      &nbsp;
      <!-- instanceCount -->
      <mat-form-field style="width: 4em;">
        <input
          matInput
          [formControl]="instanceCount"
          placeholder="count"
          type="number"
          min="0"
        />
      </mat-form-field>

      <!-- ranges -->
      <cadmus-cod-location
        [required]="true"
        [location]="initialRanges || null"
        (locationChange)="onLocationChange($event)"
      ></cadmus-cod-location>

      <!-- flags -->
      <fieldset *ngIf="availFlags?.length">
        <legend>features</legend>
        <cadmus-ui-flags-picker
          [flags]="availFlags"
          [selectedIds]="initialFlags"
          (selectedIdsChange)="onFlagsChange($event)"
        ></cadmus-ui-flags-picker>
      </fieldset>

      <div>
        <!-- key -->
        <mat-form-field>
          <input matInput [formControl]="key" placeholder="key" />
          <mat-error
            *ngIf="$any(key).errors?.pattern && (key.dirty || key.touched)"
            >invalid key</mat-error
          >
          <mat-error
            *ngIf="$any(key).errors?.maxLength && (key.dirty || key.touched)"
            >key too long</mat-error
          >
        </mat-form-field>
        &nbsp;
        <!-- parentKey -->
        <mat-form-field *ngIf="parentKeys?.length">
          <mat-select [formControl]="parentKey" placeholder="parent key">
            <mat-option [value]="null">(none)</mat-option>
            <mat-option *ngFor="let k of parentKeys" [value]="k">{{
              k
            }}</mat-option>
          </mat-select>
        </mat-form-field>
      </div>
    </mat-tab>

    <!-- TYPOLOGIES -->
    <mat-tab label="typologies">
      <div style="display: flex; gap: 8px">
        <!-- lineHeight -->
        <mat-form-field
          style="flex: 0 0 auto; width: 4em"
          *ngIf="!$any(hidden)?.lineHeight"
        >
          <input
            matInput
            type="number"
            min="0"
            [formControl]="lineHeight"
            placeholder="ln.h"
          />
        </mat-form-field>
        <!-- textRelation -->
        <mat-form-field
          *ngIf="!$any(hidden)?.textRelation"
          style="display: 1 0 auto"
        >
          <input
            matInput
            [formControl]="textRelation"
            placeholder="text relation"
          />
          <mat-error
            *ngIf="
              $any(textRelation).errors?.maxLength &&
              (textRelation.dirty || textRelation.touched)
            "
            >textRelation too long</mat-error
          >
        </mat-form-field>
      </div>
      <!-- typologies -->
      <fieldset *ngIf="availTypologies?.length">
        <legend>typologies</legend>
        <cadmus-ui-flags-picker
          [flags]="availTypologies"
          [selectedIds]="initialTypologies"
          (selectedIdsChange)="onTypologiesChange($event)"
        ></cadmus-ui-flags-picker>
      </fieldset>

      <!-- subject -->
      <div *ngIf="!$any(hidden)?.subject">
        <mat-form-field>
          <input matInput [formControl]="subject" placeholder="subject" />
          <mat-error
            *ngIf="
              $any(subject).errors?.maxLength &&
              (subject.dirty || subject.touched)
            "
            >subject too long</mat-error
          >
        </mat-form-field>
      </div>

      <!-- colors -->
      <fieldset *ngIf="availColors?.length && !$any(hidden)?.colors">
        <legend>colors</legend>
        <cadmus-ui-flags-picker
          [flags]="availColors"
          [selectedIds]="initialColors"
          (selectedIdsChange)="onColorsChange($event)"
        ></cadmus-ui-flags-picker>
      </fieldset>

      <!-- gildings -->
      <fieldset *ngIf="availGildings?.length && !$any(hidden)?.gildings">
        <legend>gildings</legend>
        <cadmus-ui-flags-picker
          [flags]="availGildings"
          [selectedIds]="initialGildings"
          (selectedIdsChange)="onGildingsChange($event)"
        ></cadmus-ui-flags-picker>
      </fieldset>

      <!-- techniques -->
      <fieldset *ngIf="availTechniques?.length && !$any(hidden)?.techniques">
        <legend>techniques</legend>
        <cadmus-ui-flags-picker
          [flags]="availTechniques"
          [selectedIds]="initialTechniques"
          (selectedIdsChange)="onTechniquesChange($event)"
        ></cadmus-ui-flags-picker>
      </fieldset>

      <!-- tools -->
      <fieldset *ngIf="availTools?.length && !$any(hidden)?.tools">
        <legend>tools</legend>
        <cadmus-ui-flags-picker
          [flags]="availTools"
          [selectedIds]="initialTools"
          (selectedIdsChange)="onToolsChange($event)"
        ></cadmus-ui-flags-picker>
      </fieldset>

      <!-- positions -->
      <fieldset *ngIf="availPositions?.length && !$any(hidden)?.positions">
        <legend>positions</legend>
        <cadmus-ui-flags-picker
          [flags]="availPositions"
          [selectedIds]="initialPositions"
          (selectedIdsChange)="onPositionsChange($event)"
        ></cadmus-ui-flags-picker>
      </fieldset>
    </mat-tab>

    <!-- DESCRIPTION -->
    <mat-tab label="description">
      <div>
        <ngx-monaco-editor
          #dsceditor
          [options]="editorOptions"
          [formControl]="description"
        ></ngx-monaco-editor>
        <mat-error
          *ngIf="
            $any(description).errors?.maxLength &&
            (description.touched || description.dirty)
          "
          >description too long</mat-error
        >
      </div>
      <div>
        <!-- images -->
        <cadmus-cod-images
          [typeEntries]="imgTypeEntries"
          [images]="initialImages"
          (imagesChange)="onImagesChange($event)"
        ></cadmus-cod-images>
      </div>
      <div>
        <!-- note -->
        <mat-form-field class="long-text">
          <textarea
            rows="2"
            matInput
            [formControl]="note"
            placeholder="note"
          ></textarea>
          <mat-error
            *ngIf="$any(note).errors?.maxLength && (note.dirty || note.touched)"
            >note too long</mat-error
          >
        </mat-form-field>
      </div>
    </mat-tab>
  </mat-tab-group>

  <!-- buttons -->
  <div>
    <button
      type="button"
      color="warn"
      mat-icon-button
      matTooltip="Discard element changes"
      (click)="cancel()"
    >
      <mat-icon>clear</mat-icon>
    </button>
    <button
      type="submit"
      color="primary"
      mat-icon-button
      matTooltip="Accept element changes"
      [disabled]="form.invalid || form.pristine"
    >
      <mat-icon>check_circle</mat-icon> element
    </button>
  </div>
</form>
